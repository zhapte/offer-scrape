name: Daily McArthurGlen Offers

on:
  schedule:
    - cron: "0 17 * * *"   # 09:00 Vancouver (PST). Adjust as needed.
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PLAYWRIGHT_BROWSERS_PATH: $HOME/.cache/ms-playwright
      TZ: America/Vancouver
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "playwright==1.*"; fi
          pip install requests
          python -m playwright install chromium
          python -m playwright install-deps

      - name: Run scraper
        run: |
          python offer.py --timeout 90000

      # Compute diff -> set outputs
      - name: Detect changes
        id: diff
        run: |
          python - << 'PY'
          import json, pathlib, os, sys
          p_new = pathlib.Path("offers_latest.json")
          p_prev = pathlib.Path("offers_latest.prev.json")
          new  = json.loads(p_new.read_text(encoding="utf-8")) if p_new.exists() else []
          prev = json.loads(p_prev.read_text(encoding="utf-8")) if p_prev.exists() else []
          nk = {(o.get("brand"), o.get("title")) for o in new}
          ok = {(o.get("brand"), o.get("title")) for o in prev}
          added   = [b for b in new  if (b["brand"], b["title"]) in (nk-ok)]
          removed = [b for b in prev if (b["brand"], b["title"]) in (ok-nk)]
          has_changes = "true" if (added or removed) else "false"

          def fmt(items, sign):
              out = []
              for i in items[:10]:
                  b = i.get("brand") or "Unknown"
                  t = i.get("title") or ""
                  dp = i.get("discount_percent")
                  pct = f" ({dp}%)" if isinstance(dp, int) else ""
                  out.append(f"{sign} **{b}**{pct} — {t}")
              return "\n".join(out)

          summary = f"**McArthurGlen Offers – {len(new)} offers** | +{len(added)} / -{len(removed)} changes"
          content = summary
          if added:   content += "\n\n**New/changed:**\n" + fmt(added, "+")
          if removed: content += "\n\n**Ended/removed:**\n" + fmt(removed, "-")
          content = content[:1900]

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"has_changes={has_changes}\n")
              # escape % and newlines for safe output
              f.write("message<<EOF\n"); f.write(content); f.write("\nEOF\n")
          PY

      # Notify ONLY if changed
      - name: Notify Discord (only on change)
        if: steps.diff.outputs.has_changes == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python - << 'PY'
          import os, requests
          url = os.environ.get("DISCORD_WEBHOOK")
          if not url: raise SystemExit(0)
          msg = """${{ steps.diff.outputs.message }}"""
          r = requests.post(url, json={"content": msg})
          print("Discord HTTP status:", r.status_code)
          r.raise_for_status()
          PY

      - name: Commit CSV/JSON to repo
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add offers_latest.csv offers_latest.json offers_latest.prev.json || true
          git commit -m "Daily scrape: $(date -u '+%Y-%m-%d %H:%M:%S') UTC" || echo "No changes to commit"
          git push || true
